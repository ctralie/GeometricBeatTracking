<html>
<head>
    <script src="jslibs/d3.min.js"></script>
</head>
<body>

<h1>d3 Audio Novelty Function Viewer</h1>
<h2>by Chris Tralie</h2>

<HR>
    <Ul>
        <li>Load in a JSON file generated by SoundTools.py using the "exportNovFnToViewer()" function</li>
        <li>Click Play/Pause to Play/Pause the audio.  The audio novelty function will come in from the right, synchronized with the audio</li>
    </Ul>
<table>
<tr><td><h3>File Input</h3></td><td><input type = "file" id = "fileInput"></td><td colspan = "2"></td></tr>
</table>

<table>
    <tr>
        <td><audio id="audio_widget" controls></audio></td>
    </tr>
    <tr>
        <td><svg id="novfn_canvas"></svg></td>
    </tr>
</table>

<!--lineGraph.attr("transform", "translate("+i+", 0)");-->
<script>
    const width = 800;
    const height = 300;
    audio_widget = document.getElementById("audio_widget");
    audio_widget.style.width = width + 'px';
    hopSize = 512.0;
    Fs = 44100.0;
    secsPerScreen = 2; /*How many seconds of the audio novelty
                        *function to have in view at any time*/
    dpix = width/(secsPerScreen*Fs/hopSize); /*Shift between each sample in pixels*/
    novFn = [];
    d3.select("#audio_widget").attr("width", width);
    var playing = false;
    var svgContainer = d3.select("#novfn_canvas")
                                .attr("width", width)
                                .attr("height", height);
    var lineGraph = svgContainer.append("path")
                                .attr("stroke", "blue")
                                .attr("stroke-width", 2)
                                .attr("fill", "none");



    /**
     * Update the shift of the svg to be synchronized
     * to the position of the audio
     */
    updateShift = function() {
        let sample = -(audio_widget.currentTime-secsPerScreen)*Fs/hopSize;
        lineGraph.attr("transform", "translate("+sample*dpix+", 0)");
        if (playing) {
            requestAnimationFrame(updateShift);
        }
    }

    playfn = function() {
        playing = true;
        requestAnimationFrame(updateShift);
    }
    pausefn = function() {
        playing = false;
    }
    audio_widget.addEventListener("play", playfn);
    audio_widget.addEventListener("pause", pausefn);
    audio_widget.addEventListener("seek", updateShift);

    /** 
     * Setup file input button handler 
     */
    var fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', function(e) {
        var file = fileInput.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
            const params = JSON.parse(reader.result);
            hopSize = params.hopSize;
            Fs = params.Fs;
            console.log("hopSize = " + hopSize);
            dpix = width/(secsPerScreen*Fs/hopSize);
            console.log("dpix = " + dpix);
            samplesPerScreen = Math.round(secsPerScreen*Fs/hopSize);
            audio_widget.src = params.audio;
            novFn = params.novFn;
            yScale = height/d3.max(novFn);
            lineFunction = d3.line()
                            .x(function(d, i) { return i*dpix; })
                            .y(function(d) { return height-d*yScale; });

            lineGraph.attr("d", lineFunction(novFn));
        };
        reader.readAsText(file);
    });
</script>

</body>
</html>
